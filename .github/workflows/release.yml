name: "Release"

on:
  push:
    tags:
      # Publish on any tag starting with a `v`, e.g., v0.1.0
      - v*

jobs:
  run:
    runs-on: ubuntu-latest
    environment:
      name: pypi
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Set version from tag
        run: uv version ${GITHUB_REF_NAME#v}
      - name: Install Python 3.14
        run: uv python install 3.14
      - name: Install project
        run: uv sync --locked
      - name: Update README with --help output
        run: |
          uv run python - <<'EOF'
          import subprocess, re

          result = subprocess.run(
              ["ftm-random", "--help"], capture_output=True, text=True
          )
          help_text = result.stdout

          with open("README.md") as f:
              content = f.read()

          new_block = (
              "<!-- help-start -->\n"
              "```\n"
              "$ ftm-random --help\n"
              + help_text
              + "```\n"
              "<!-- help-end -->"
          )
          new_content = re.sub(
              r"<!-- help-start -->.*?<!-- help-end -->",
              new_block,
              content,
              flags=re.DOTALL,
          )

          with open("README.md", "w") as f:
              f.write(new_content)
          EOF
      - name: Generate changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --verbose --tag ${{ github.ref_name }}
        env:
          OUTPUT: CHANGELOG.md
      - name: Commit and push updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml README.md CHANGELOG.md
          if ! git diff --cached --quiet; then
            git commit -m "chore(release): update README and CHANGELOG for ${{ github.ref_name }} [skip ci]"
            git push origin HEAD:main
          fi
      - name: Build
        run: uv build
      # Check that basic features work and we didn't miss to include crucial files
      #- name: Smoke test (wheel)
      #  run: uv run --isolated --no-project --with dist/*.whl tests/smoke_test.py
      #- name: Smoke test (source distribution)
      #  run: uv run --isolated --no-project --with dist/*.tar.gz tests/smoke_test.py
      - name: Publish
        run: uv publish
      - name: Extract release notes from CHANGELOG
        run: awk '/^## \[/{if(found) exit; found=1} found{print}' CHANGELOG.md > RELEASE_NOTES.md
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          files: dist/*
